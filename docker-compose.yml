version: "3.8"

networks:
  kafka_network:

x-check-ports: &check-ports ./bin/check-ports:/bin/check-ports
x-service-template: &template
  restart: on-failure
  networks:
    - kafka_network
  healthcheck: &hc
    interval: 5s
    timeout: 3s
    start_period: 10s
    retries: 30
  volumes:
    - *check-ports

x-public-key: &pub >
  ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILArDnLYVp+/JkcrJKHX5XDpFj2MdA6NmV09vh7DmVrD dind

x-private-key: &private |+
  -----BEGIN OPENSSH PRIVATE KEY-----
  b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
  QyNTUxOQAAACCwKw5y2FafvyZHKySh1+Vw6RY9jHQOjZldPb4ew5lawwAAAJggO3ZdIDt2
  XQAAAAtzc2gtZWQyNTUxOQAAACCwKw5y2FafvyZHKySh1+Vw6RY9jHQOjZldPb4ew5laww
  AAAEA6oPfTO+faTshF1LXPJNKihyWNqL5QQejwBnFQ8UK4o7ArDnLYVp+/JkcrJKHX5XDp
  Fj2MdA6NmV09vh7DmVrDAAAAD3NwYXJrLWV4ZXJjaXNlcwECAwQFBg==
  -----END OPENSSH PRIVATE KEY-----

x-depends-on-kafka: &depends-on-kafka
  kafka1:
    condition: service_healthy
  kafka2:
    condition: service_healthy
  kafka3:
    condition: service_healthy

services:
  manager:
    <<: *template
    image: neshkeev/bash-notebook
    hostname: &name manager
    container_name: *name
    command: /usr/local/bin/entrypoint
    healthcheck:
      <<: *hc
      test: /bin/check-ports 8888
    ports:
      - "8888:8888"
    depends_on:
      <<: *depends-on-kafka
      dind:
        condition: service_healthy
    volumes:
      - *check-ports
      - ./bin/manager-entrypoint:/usr/local/bin/entrypoint
      - ./bin/manager.bash_aliases:/home/jovyan/.bash_aliases
      - ./work/work.ipynb:/home/jovyan/work/work.ipynb
    environment:
      KAFKA_HOST: kafka1
      KAFKA_PORT: 9092
      ZOOKEEPER_HOST: zoo
      ZOOKEEPER_PORT: 2181
      DIND_HOST: dind
      NOTEBOOK_ARGS: --NotebookApp.token='' --NotebookApp.password=''
      RESTARTABLE: yes
      SSH_PRIVATE_KEY: *private

  dind:
    <<: *template
    image: neshkeev/dind
    hostname: &name dind
    container_name: *name
    command: version
    healthcheck:
      <<: *hc
      test: sh /bin/check-ports 22
    volumes:
      - *check-ports
      - /var/run/docker.sock:/var/run/docker.sock
      - .:/${COMPOSE_PROJECT_NAME}
    environment:
      SSH_PUB_KEY: *pub

  zoo:
    <<: *template
    image: confluentinc/cp-zookeeper:7.4.0
    hostname: &zname zoo
    container_name: *zname
    healthcheck:
      <<: *hc
      test: /bin/check-ports 2181
    volumes:
      - *check-ports
      - ./conf/zk_jaas.conf:/conf/zk_jaas.conf
    environment:
      ZOOKEEPER_SERVER_ID: 1
      ZOOKEEPER_CLIENT_PORT: "2181"
      KAFKA_OPTS: -Djava.security.auth.login.config=/conf/zk_jaas.conf
                  -Dzookeeper.authProvider.1=org.apache.zookeeper.server.auth.SASLAuthenticationProvider
                  -DrequireClientAuthScheme=sasl

  kafka1: &kafka
    <<: *template
    image: confluentinc/cp-kafka:7.4.0
    hostname: &name kafka1
    container_name: *name
    healthcheck:
      <<: *hc
      test: /bin/check-ports 39092 29092 19092 9092
    depends_on:
      zoo:
        condition: service_healthy
    volumes:
      - *check-ports
      - ./conf/kafka_jaas.conf:/etc/kafka/kafka_jaas.conf
    environment: &kafka_env
      KAFKA_BROKER_ID: 1
      KAFKA_LISTENERS: &listeners >
        MANAGER://kafka1:9092,
        CLIENT://kafka1:19092,
        INTER://kafka1:29092,
        ZOO://kafka1:39092
      KAFKA_ADVERTISED_LISTENERS: *listeners
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: >
        MANAGER:PLAINTEXT,
        CLIENT:SASL_PLAINTEXT,
        INTER:PLAINTEXT,
        ZOO:PLAINTEXT
      KAFKA_AUTHORIZER_CLASS_NAME: kafka.security.authorizer.AclAuthorizer
      KAFKA_ALLOW_EVERYONE_IF_NO_ACL_FOUND: true
      KAFKA_INTER_BROKER_LISTENER_NAME: INTER
      KAFKA_CONTROL_PLANE_LISTENER_NAME: ZOO
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_ZOOKEEPER_CONNECT: "zoo:2181"
      KAFKA_OPTS: -Djava.security.auth.login.config=/etc/kafka/kafka_jaas.conf
      KAFKA_SASL_MECHANISM_INTER_BROKER_PROTOCOL: PLAIN
      KAFKA_SASL_ENABLED_MECHANISMS: PLAIN

  kafka2:
    << : *kafka
    hostname: &name kafka2
    container_name: *name
    environment:
      <<: *kafka_env
      KAFKA_BROKER_ID: 2
      KAFKA_LISTENERS: &listeners >
        MANAGER://kafka2:9092,
        CLIENT://kafka2:19092,
        INTER://kafka2:29092,
        ZOO://kafka2:39092
      KAFKA_ADVERTISED_LISTENERS: *listeners

  kafka3:
    << : *kafka
    hostname: &name kafka3
    container_name: *name
    environment:
      <<: *kafka_env
      KAFKA_BROKER_ID: 3
      KAFKA_LISTENERS: &listeners >
        MANAGER://kafka3:9092,
        CLIENT://kafka3:19092,
        INTER://kafka3:29092,
        ZOO://kafka3:39092
      KAFKA_ADVERTISED_LISTENERS: *listeners

  redpanda:
    <<: *template
    image: docker.redpanda.com/redpandadata/console:v2.2.4
    hostname: &rname redpanda
    container_name: *rname
    depends_on: *depends-on-kafka
    ports:
      - "8080:8080"
    healthcheck:
      <<: *hc
      test: sh /bin/check-ports 8080
    environment:
      KAFKA_BROKERS: kafka1:9092
