version: "3.8"

networks:
  kafka_network:

x-check-ports: &check-ports ./bin/check-ports:/bin/check-ports
x-service-template: &template
  restart: on-failure
  networks:
    - kafka_network
  healthcheck: &hc
    interval: 5s
    timeout: 3s
    start_period: 10s
    retries: 30
  volumes:
    - *check-ports

x-public-key: &pub >
  ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILArDnLYVp+/JkcrJKHX5XDpFj2MdA6NmV09vh7DmVrD dind

x-private-key: &private |+
  -----BEGIN OPENSSH PRIVATE KEY-----
  b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
  QyNTUxOQAAACCwKw5y2FafvyZHKySh1+Vw6RY9jHQOjZldPb4ew5lawwAAAJggO3ZdIDt2
  XQAAAAtzc2gtZWQyNTUxOQAAACCwKw5y2FafvyZHKySh1+Vw6RY9jHQOjZldPb4ew5laww
  AAAEA6oPfTO+faTshF1LXPJNKihyWNqL5QQejwBnFQ8UK4o7ArDnLYVp+/JkcrJKHX5XDp
  Fj2MdA6NmV09vh7DmVrDAAAAD3NwYXJrLWV4ZXJjaXNlcwECAwQFBg==
  -----END OPENSSH PRIVATE KEY-----

x-depends-on-kafka: &depends-on-kafka
  kafka:
    condition: service_healthy

services:
  manager:
    <<: *template
    image: neshkeev/bash-notebook
    hostname: &mname manager
    container_name: *mname
    command: /usr/local/bin/entrypoint
    healthcheck:
      <<: *hc
      test: /bin/check-ports 8888
    ports:
      - "8888:8888"
    depends_on:
      <<: *depends-on-kafka
      connect:
        condition: service_healthy
      postgres:
        condition: service_healthy
    volumes:
      - *check-ports
      - ./bin/manager-entrypoint:/usr/local/bin/entrypoint
      - ./bin/manager.bash_aliases:/home/jovyan/.bash_aliases
      - ./work/work.ipynb:/home/jovyan/work/work.ipynb
    environment:
      KAFKA_HOST: kafka
      KAFKA_PORT: 9092
      CONNECT_HOST: connect
      NOTEBOOK_ARGS: --NotebookApp.token='' --NotebookApp.password=''
      RESTARTABLE: yes
      SSH_PRIVATE_KEY: *private

  dind:
    <<: *template
    image: neshkeev/dind
    hostname: &name dind
    container_name: *name
    command: version
    healthcheck:
      <<: *hc
      test: sh /bin/check-ports 22
    volumes:
      - *check-ports
      - /var/run/docker.sock:/var/run/docker.sock
      - .:/${COMPOSE_PROJECT_NAME}
    environment:
      SSH_PUB_KEY: *pub

  kafka:
    <<: *template
    image: confluentinc/cp-kafka:7.4.0
    hostname: &name kafka
    container_name: *name
    ports:
      - "9010:9010"
    healthcheck:
      <<: *hc
      test: /bin/check-ports 9092 19092 9010
    environment:
      CLUSTER_ID: JS-9P8KdQGG_lCVXikxM5w
      KAFKA_NODE_ID: 1

      KAFKA_PROCESS_ROLES: >
        controller,
        broker
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:19092

      KAFKA_LISTENERS: &listeners BROKER://kafka:9092, CONTROLLER://kafka:19092
      KAFKA_ADVERTISED_LISTENERS: BROKER://kafka:9092
      KAFKA_INTER_BROKER_LISTENER_NAME: BROKER
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: >
        BROKER:PLAINTEXT,
        CONTROLLER:PLAINTEXT

      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      EXTRA_ARGS: >
        -XX:StartFlightRecording=filename=/tmp/kafka.jfr
        -Dcom.sun.management.jmxremote
        -Dcom.sun.management.jmxremote.port=9010
        -Dcom.sun.management.jmxremote.rmi.port=9010
        -Dcom.sun.management.jmxremote.local.only=true
        -Dcom.sun.management.jmxremote.authenticate=false
        -Dcom.sun.management.jmxremote.ssl=false
        -Djava.rmi.server.hostname=127.0.0.1

  redpanda:
    <<: *template
    image: docker.redpanda.com/redpandadata/console:v2.2.4
    hostname: &name redpanda
    container_name: *name
    depends_on:
      <<: *depends-on-kafka
      connect:
        condition: service_healthy
      schema-registry:
        condition: service_healthy
    ports:
      - "8080:8080"
    healthcheck:
      <<: *hc
      test: sh /bin/check-ports 8080
    environment:
      KAFKA_BROKERS: kafka:9092
      KAFKA_SCHEMAREGISTRY_ENABLED: true
      KAFKA_SCHEMAREGISTRY_URLS: http://schema-registry:8081
      CONNECT_ENABLED: true
      CONNECT_CLUSTERS_NAME: local
      CONNECT_CLUSTERS_URL: http://connect:8083

  schema-registry:
    <<: *template
    image: confluentinc/cp-schema-registry:7.4.0
    hostname: &name schema-registry
    container_name: *name
    depends_on: *depends-on-kafka
    healthcheck:
      <<: *hc
      test: /bin/check-ports 8081
    environment:
      SCHEMA_REGISTRY_HOST_NAME: schema-registry
      SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS: kafka:9092
      SCHEMA_REGISTRY_LISTENERS: http://0.0.0.0:8081

  connect:
    <<: *template
    image: confluentinc/cp-kafka-connect:7.4.0
    hostname: &name connect
    container_name: *name
    depends_on:
      <<: *depends-on-kafka
      schema-registry:
        condition: service_healthy
    healthcheck:
      <<: *hc
      test: /bin/check-ports 8083
    environment:
      CONNECT_BOOTSTRAP_SERVERS: kafka:9092
      CONNECT_REST_ADVERTISED_HOST_NAME: connect
      CONNECT_REST_PORT: 8083
      CONNECT_GROUP_ID: compose-connect-group
      CONNECT_CONFIG_STORAGE_TOPIC: docker-connect-configs
      CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR: 1
      CONNECT_OFFSET_STORAGE_TOPIC: docker-connect-offsets
      CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR: 1
      CONNECT_STATUS_STORAGE_TOPIC: docker-connect-status
      CONNECT_STATUS_STORAGE_REPLICATION_FACTOR: 1
      CONNECT_KEY_CONVERTER: org.apache.kafka.connect.storage.StringConverter
      CONNECT_VALUE_CONVERTER: io.confluent.connect.avro.AvroConverter
      CONNECT_VALUE_CONVERTER_SCHEMA_REGISTRY_URL: http://schema-registry:8081

  postgres:
    <<: *template
    image: postgres:16
    container_name: &name postgres
    hostname: *name
    healthcheck:
      <<: *hc
      test: /bin/check-ports 5432
    volumes:
      - *check-ports
      - ./db:/docker-entrypoint-initdb.d/
    environment:
      POSTGRES_DB: postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres

  debezium:
    <<: *template
    image: quay.io/debezium/connect:2.3
    container_name: &name debezium
    hostname: *name
    command: bash /bin/entrypoint
    depends_on:
      schema-registry:
        condition: service_healthy
    healthcheck:
      <<: *hc
      test: /bin/check-ports 8083
    volumes:
      - *check-ports
      - ./bin/debezium-entrypoint:/bin/entrypoint
    environment:
      BOOTSTRAP_SERVERS: kafka:9092
      GROUP_ID: 1
      CONFIG_STORAGE_TOPIC: connect_debezium_configs
      OFFSET_STORAGE_TOPIC: connect_debezium_offsets
      KEY_CONVERTER: io.confluent.connect.avro.AvroConverter
      VALUE_CONVERTER: io.confluent.connect.avro.AvroConverter
      CONNECT_KEY_CONVERTER_SCHEMA_REGISTRY_URL: http://schema-registry:8081
      CONNECT_VALUE_CONVERTER_SCHEMA_REGISTRY_URL: http://schema-registry:8081
